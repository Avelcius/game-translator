# RPG Maker Translator (Gemini)

Небольшой скрипт для пакетного перевода текстовых файлов (форматы `maps` и `other`) из английского в русский с помощью Google Gemini (пакет `google-genai`). Скрипт сохраняет управляющие последовательности (например, `\i[...]`, `\#`, `\.`) и поддерживает умный бэкофф при превышении квот (HTTP 429).

## Что делает
- Находит строки в папках `maps` и `other` (рекурсивно) и собирает тексты для перевода.
- Маскирует управляющие последовательности перед отправкой, чтобы модель не изменила теги/escape-последовательности.
- Отправляет большие батчи (по умолчанию 10_000 строк) в Gemini и получает переводы.
- При ошибке 429: ждёт 60 секунд и пробует тот же батч ещё раз; если снова 429 — уменьшает размер батча вдвое (по умолчанию 5_000) для следующих 2 чанков, затем восстанавливает исходный размер.
- Сохраняет результаты в папке `<source>_RU` рядом с исходной папкой и пишет `translate_log.json` с записью всех переводов и статусов.
- Поддерживает повторную попытку незавершённых переводов через `retry_from_log`.
- для получения `maps` и `other` для перевода используйте https://github.com/savannstm/rvpacker-txt
## Требования
- Python 3.10+ (проверено на Windows с `py`)
- Пакеты:
  - `google-genai`
  - `pydantic`

Можно установить минимальные зависимости так (PowerShell):

```powershell
py -m pip install google-genai pydantic
```

Скрипт также содержит функцию `install_dependencies()`, которая попытается установить `google-genai`, если пакет не найден.

## Переменные окружения / API-ключ
Скрипт при запуске предложит ввести API-ключ Gemini. Если вы не введёте ключ вручную, клиент попытается использовать ключ из окружения. Возможные переменные окружения, которые может использовать SDK:
- `GOOGLE_API_KEY` (часто используется)
- `GEMINI_API_KEY` (альтернативно)

Если при настройке клиента вы получаете ошибку, проверьте, установлен ли пакет `google-genai` и нет ли конфликта с пакетом `google` (если пакет `google` установлен, удалите его: `py -m pip uninstall google`).

## Быстрый запуск
1. Поместите исходные файлы в папку — внутри неё должны быть подпапки `maps` и/или `other`, либо используйте любую структуру, но тогда при выборе категорий укажите `other`.
2. Запустите:

```powershell
py main.py
```

3. Введите API-ключ (или нажмите Enter, чтобы использовать переменную окружения).
4. Укажите путь к папке с файлами для перевода (абсолютный или относительный).
5. Выберите категории для обработки (`maps`, `other`, `all`).

После выполнения результат будет в папке `<имя_исходной_папки>_RU` рядом с исходной.

## Поведение батчинга и 429 (точно под ваш запрос)
- По умолчанию скрипт отправляет батчи по 10_000 строк (значение `batch_size` в `process_files`).
- Если при отправке батча приходит ошибка 429, скрипт:
  1. Ждёт 60 секунд и пробует ещё раз тот же батч (10_000).
  2. Если снова 429 — уменьшает размер батча ровно вдвое (половина базового `batch_size`, например 5_000) и использует этот уменьшенный размер для следующих 2 чанков.
  3. После двух уменьшенных чанков размер батча восстанавливается до базового (`batch_size`, т.е. 10_000).

Таким образом последовательность при проблемах с квотами будет: 10_000 → (если 429) wait 60s → retry 10_000 → (если 429 снова) 5_000 for next 2 chunks → restore 10_000.

Если вам нужно другое поведение, можно изменить `batch_size` и/или логику в `batch_translate`.

## Лог и повторные попытки
- По окончании создаётся `translate_log.json` в папке вывода. В нём для каждой записи хранится исходный текст, маскировка, токены, путь к файлу, индекс, статус (`ok` или `missing`) и перевод при наличии.
- Скрипт предложит сразу выполнить `retry_from_log` для всех записей со статусом `missing`.
- Также можно вручную вызвать функцию `retry_from_log(path_to_translate_log.json)` (или запустить скрипт и выбрать опцию повторного запуска логики).

## Настройка и оптимизация
- Быстрая оптимизация по квотам: уменьшите `batch_size` в `process_files` (строка с комментарием про batch) — это снизит вероятность 429, но увеличит число HTTP-запросов.
- Если часто получаете 429 из-за токен-лимитов, рассмотрите запуск с меньшим `batch_size` (например, 2000–5000) или договоритесь о повышении квот на стороне Google Cloud.
- Можно также добавить persistent-кеширование переводов (словарь/файл) чтобы не повторять одинаковые фразы.

## Отладка
- Ошибка "module 'google.genai' has no attribute 'configure'": значит установлена старая/не та версия SDK или конфликт с другим пакетом `google`. Решение:
  - Удалите конфликтующий пакет: `py -m pip uninstall google` (если установлен), затем установите `google-genai`:

```powershell
py -m pip install --upgrade google-genai
```

- Если возникают ошибки сети/SSL, проверьте доступ в интернет и настройки прокси.
- При частых 429 проверьте баланс/квоты и логи использования в Google Cloud Console: https://ai.google.dev/gemini-api/docs/rate-limits

## Безопасность и расходы
- Использование Gemini может стоить денег в зависимости от модели и использования. Проверьте ваши тарифы и лимиты.
- Не храните публично ваш API-ключ. Рассмотрите использование переменных окружения вместо ввода ключа в консоли.

## Примеры
Запустить перевод папки `my_texts`:

```powershell
py main.py
# затем в интерактивных подсказках ввести путь к папке C:\path\to\my_texts
```

Повторить незавершённые переводы (если лог уже есть):

```powershell
# в Python REPL или отдельном скрипте
from main import retry_from_log
retry_from_log(r"C:\path\to\my_texts_RU\translate_log.json")
```

## Что можно добавить далее
- CLI-параметры (`--batch-size`, `--categories`, `--api-key`) для неинтерактивного запуска.
- Кеш переводов (файл/SQLite) для экономии запросов.
- Более интеллектуальный экспоненциальный backoff для 429.
- Логирование событий rate-limit в отдельный файл.

## Лицензия
MIT — используйте и модифицируйте как удобно.
